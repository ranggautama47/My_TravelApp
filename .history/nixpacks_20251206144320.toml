[phases.setup]
aptPkgs = [
  "php",
  "php-cli",
  "php-fpm",
  "php-mysql",
  "php-zip",
  "php-mbstring",
  "php-xml",
  "php-curl",
  "php-gd",
  "php-intl",
  "php-bcmath",
  "php-soap",
  "php-readline",
  "php-tokenizer",
  "php-json",
  "php-redis",
  "curl",
  "nginx",
]

[phases.install]
cmds = [
  "curl -sS https://getcomposer.org/installer -o composer-setup.php",
  "php composer-setup.php --install-dir=/usr/local/bin --filename=composer",
  "composer install --no-dev --optimize-autoloader",
  "npm install",
  "npm run build"
]

[phases.build]
cmds = [
  "mkdir -p storage/framework/sessions storage/framework/views storage/framework/cache data",
  "chmod -R 775 storage bootstrap/cache"
]

[start]
cmd = "nginx -g 'daemon off;' | php-fpm -F"

# Nginx config
[variables]
NGINX_CONF = """
server {
    listen 8080;
    root /app/public;
    index index.php index.html;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
"""
